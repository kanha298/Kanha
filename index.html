<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Social App</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body{font-family:sans-serif;padding:10px}

/* sections */
#postSection, #chatSection {
  display: none; /* ðŸ”’ locked by default */
}

#chat{
  height:120px;
  border:1px solid #ccc;
  overflow:auto;
  margin:5px 0;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginSection">
  <input id="name" placeholder="Enter name">
  <button onclick="register()">Login / Register</button>
</div>

<p id="uid"></p>

<hr>

<!-- POST -->
<div id="postSection">
  <textarea id="postText" placeholder="Write a post"></textarea><br>
  <button onclick="createPost()">Post</button>
  <div id="feed"></div>
</div>

<hr>

<!-- CHAT -->
<div id="chatSection">
  <input id="to" placeholder="Receiver User ID"><br>
  <div id="chat"></div>
  <input id="msg" placeholder="Message">
  <button onclick="sendMsg()">Send</button>
</div>

<script>
const API = "https://kanha-1-k2ld.onrender.com";

let userId = null;
let socket = null;

/* REGISTER */
function register(){
  if(!name.value){
    alert("Enter name");
    return;
  }

  fetch(API + "/register", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ name: name.value })
  })
  .then(r=>r.json())
  .then(d=>{
    userId = d.id;
    uid.innerText = "Your ID: " + userId;

    // ðŸ”“ unlock UI
    loginSection.style.display = "none";
    postSection.style.display = "block";
    chatSection.style.display = "block";

    // socket connect
    socket = io(API);
    socket.emit("join", userId);

    socket.on("receive", m=>{
      chat.innerHTML += `<p><b>${m.from}:</b> ${m.msg}</p>`;
    });

    loadPosts();
  });
}

/* POSTS */
function createPost(){
  fetch(API + "/post", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      userId:userId,
      text:postText.value
    })
  }).then(()=>{
    postText.value="";
    loadPosts();
  });
}

function loadPosts(){
  fetch(API + "/posts")
    .then(r=>r.json())
    .then(p=>{
      feed.innerHTML = p.map(x=>`<p>${x.text}</p>`).join("");
    });
}

/* CHAT */
function sendMsg(){
  socket.emit("send",{
    from:userId,
    to:to.value,
    msg:msg.value
  });
  msg.value="";
}
</script>

</body>
</html>
